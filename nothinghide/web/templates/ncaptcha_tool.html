{% extends "base.html" %}

{% block title %}NCaptcha - Advanced Behavioral Verification{% endblock %}

{% block content %}
<div class="container">
    <div class="logo">
        <a href="/"><img src="{{ url_for('static', path='/logo-title.png') }}" alt="NothingHide" class="logo-img"></a>
    </div>
    
    <div class="org-banner" style="background: #000; color: #fff; padding: 10px; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px;">
        Next-Gen Bot Protection | NCaptcha
    </div>

    <h1>NCaptcha Widget</h1>
    <p class="tagline">Risk-based behavioral verification system.</p>

    <div class="result-box" style="max-width: 420px; margin: 30px auto; border: none; background: transparent; padding: 0;">
        <div id="ncaptcha-widget-container">
            <div id="nc-main-box" style="border: 1px solid #dcdcdc; background: #fff; padding: 12px 16px; display: flex; align-items: center; gap: 14px; border-radius: 4px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px rgba(0,0,0,0.08); position: relative; overflow: hidden; height: 74px; box-sizing: border-box;">
                <div id="nc-ripple" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(77, 144, 254, 0.05); transform: translateX(-100%); transition: transform 0.6s ease;"></div>
                
                <div id="nc-check" style="width: 28px; height: 28px; border: 2px solid #c1c1c1; background: #fff; border-radius: 3px; display: flex; align-items: center; justify-content: center; position: relative; z-index: 1; transition: border-color 0.3s;">
                    <div id="nc-spinner" style="display: none; width: 16px; height: 16px; border: 2px solid #4d90fe; border-top-color: transparent; border-radius: 50%; animation: nc-spin 0.6s linear infinite;"></div>
                    <div id="nc-check-mark" style="display: none; color: #00aa00; font-size: 22px; line-height: 1; font-weight: bold;">✓</div>
                </div>
                
                <div id="nc-label" style="flex-grow: 1; text-align: left; font-size: 15px; color: #3c4043; font-weight: 500; letter-spacing: 0.1px; position: relative; z-index: 1;">Verify you are human</div>
                
                <div style="text-align: right; position: relative; z-index: 1; min-width: 60px;">
                    <img src="{{ url_for('static', path='/favicon.png') }}" id="nc-logo" style="height: 28px; opacity: 0.8; filter: grayscale(100%); transition: all 0.3s;">
                    <div style="font-size: 9px; color: #70757a; text-transform: uppercase; font-weight: 700; margin-top: 2px; letter-spacing: 0.5px;">NCaptcha</div>
                </div>
            </div>

            <div id="nc-challenge" style="display: none; margin-top: 15px; border: 1px solid #e0e0e0; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); animation: nc-slide-up 0.4s ease;">
                <div id="beat-tap-target"></div>
                <div style="margin-top: 15px; font-size: 11px; color: #5f6368; border-top: 1px solid #f1f3f4; padding-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold;">NothingHide Security Org</span>
                    <a href="/help" style="color: #1a73e8; text-decoration: none;">Privacy • Terms</a>
                </div>
            </div>
        </div>
    </div>

    <div id="nc-token-display" style="display: none; margin-top: 25px; animation: nc-slide-up 0.5s ease;">
        <div style="background: #e6f4ea; border: 1px solid #34a853; padding: 15px; border-radius: 8px; text-align: left;">
            <div style="color: #137333; font-weight: bold; font-size: 14px; margin-bottom: 5px;">Verification Successful</div>
            <p style="color: #137333; font-size: 12px; margin: 0;">A secure session token has been generated and signed by the Security Org.</p>
        </div>
        <div style="margin-top: 15px; text-align: left;">
            <div style="font-size: 11px; color: #70757a; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;">Secure Token (JWT-Style)</div>
            <code id="token-val" style="display: block; word-break: break-all; font-size: 10px; background: #f8f9fa; padding: 12px; border: 1px solid #dadce0; border-radius: 4px; font-family: monospace; color: #3c4043;"></code>
        </div>
        
        <div id="security-analysis" style="margin-top: 15px; text-align: left; background: #fdfdfd; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
            <div style="font-size: 11px; color: #70757a; font-weight: bold; text-transform: uppercase; margin-bottom: 10px;">Security Intelligence Analysis</div>
            <div id="analysis-content" style="font-size: 12px; line-height: 1.6;"></div>
        </div>
    </div>

    <div class="help-section" style="margin-top: 40px;">
        <h3>Professional Protection</h3>
        <p>NCaptcha uses real-world cybersecurity heuristics. It monitors behavioral entropy, micro-jitter in cursor movement, and hardware-level environment integrity. This is the same technology used to protect high-value banking and enterprise portals.</p>
    </div>

    <a href="/" class="back-link">Return to Portal</a>
</div>

<style>
    @keyframes nc-spin { to { transform: rotate(360deg); } }
    @keyframes nc-slide-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    #nc-main-box:hover { border-color: #4d90fe; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #nc-main-box:hover #nc-logo { filter: grayscale(0%); opacity: 1; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ncBox = document.getElementById('nc-main-box');
        const ncCheck = document.getElementById('nc-check');
        const ncSpinner = document.getElementById('nc-spinner');
        const ncCheckMark = document.getElementById('nc-check-mark');
        const ncChallenge = document.getElementById('nc-challenge');
        const ncLabel = document.getElementById('nc-label');
        const ncRipple = document.getElementById('nc-ripple');
        const tokenDisplay = document.getElementById('nc-token-display');
        const tokenVal = document.getElementById('token-val');
        const analysisContent = document.getElementById('analysis-content');
        
        let isProcessing = false;

        ncBox.onclick = async () => {
            if (isProcessing || ncCheckMark.style.display === 'block') return;
            
            isProcessing = true;
            ncLabel.innerText = 'Verifying...';
            ncSpinner.style.display = 'block';
            ncCheck.style.borderColor = '#4d90fe';
            ncRipple.style.transform = 'translateX(0)';

            try {
                if (typeof window.getNCaptchaPayload !== 'function') {
                    throw new Error('Security engine not loaded');
                }

                const payload = window.getNCaptchaPayload();
                const response = await fetch('/security/check-risk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error('Verification failed');
                
                const data = await response.json();

                if (data.risk === 'LOW') {
                    setTimeout(() => completeVerification(data), 800);
                } else {
                    ncSpinner.style.display = 'none';
                    ncChallenge.style.display = 'block';
                    ncLabel.innerText = 'Rhythm Challenge';
                    window.initBeatTap('beat-tap-target', (success) => {
                        if (success) completeVerification(data);
                    });
                }
            } catch (err) {
                console.error(err);
                resetWidget();
            }
        };

        async function completeVerification(analysis) {
            try {
                const payload = window.getNCaptchaPayload();
                const response = await fetch('/security/verify-challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...payload, challenge: 'verified' })
                });
                const data = await response.json();
                
                ncSpinner.style.display = 'none';
                ncCheckMark.style.display = 'block';
                ncChallenge.style.display = 'none';
                ncLabel.innerText = 'Verified';
                ncBox.style.background = '#f0fff0';
                ncBox.style.borderColor = '#00aa00';
                ncBox.style.cursor = 'default';
                
                tokenVal.innerText = data.token;
                tokenDisplay.style.display = 'block';
                
                // Show analysis
                let signalsHtml = '<ul style="margin:0; padding-left:15px; color:#555;">';
                if (analysis.signals && analysis.signals.length > 0) {
                    analysis.signals.forEach(s => {
                        signalsHtml += `<li>Signal detected: <strong>${s.replace(/_/g, ' ')}</strong></li>`;
                    });
                } else {
                    signalsHtml += '<li>Human behavioral signature confirmed.</li>';
                }
                signalsHtml += `<li>Risk Score: <strong>${analysis.score}/100</strong></li>`;
                signalsHtml += '</ul>';
                analysisContent.innerHTML = signalsHtml;

                isProcessing = false;
            } catch (err) {
                console.error(err);
                resetWidget();
            }
        }

        function resetWidget() {
            isProcessing = false;
            ncSpinner.style.display = 'none';
            ncCheckMark.style.display = 'none';
            ncCheck.style.borderColor = '#c1c1c1';
            ncLabel.innerText = 'Verify you are human';
            ncRipple.style.transform = 'translateX(-100%)';
            alert('Verification encountered an issue. Please try again.');
        }
    });
</script>
{% endblock %}
