{% extends "base.html" %}

{% block title %}Password Check - NothingHide{% endblock %}

{% block content %}
<style>
.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.loading-section {
    display: none;
    text-align: center;
    padding: 30px;
    margin-top: 20px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #ddd;
    border-top: 3px solid #333;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: #666;
    font-size: 14px;
}

.results-section {
    display: none;
    margin-top: 20px;
}

.result-card {
    padding: 30px;
    text-align: center;
    border: 2px solid;
}

.result-safe {
    background: #f0fff0;
    border-color: #00cc00;
    color: #006600;
}

.result-compromised {
    background: #fff0f0;
    border-color: #cc0000;
    color: #cc0000;
}

.result-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.result-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
}

.result-count {
    font-size: 14px;
    margin-bottom: 20px;
}

.strength-section {
    background: #f5f5f5;
    border: 1px solid #ddd;
    padding: 20px;
    margin-top: 20px;
}

.strength-section h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 14px;
}

.strength-bar-container {
    background: #ddd;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
}

.strength-bar {
    height: 100%;
    transition: width 0.3s;
}

.strength-weak { background: #cc0000; }
.strength-fair { background: #ff6600; }
.strength-good { background: #ffcc00; }
.strength-strong { background: #00cc00; }

.strength-label {
    font-size: 12px;
    color: #666;
    text-align: center;
}

.strength-details {
    margin-top: 15px;
}

.strength-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 12px;
    border-bottom: 1px solid #eee;
}

.strength-item:last-child {
    border-bottom: none;
}

.check-pass { color: #00cc00; }
.check-fail { color: #cc0000; }

.recommendations-section {
    background: #fff8f0;
    border: 1px solid #ff6600;
    padding: 15px;
    margin-top: 20px;
}

.recommendations-section h3 {
    margin: 0 0 10px 0;
    color: #cc6600;
    font-size: 14px;
}

.recommendation-item {
    padding: 8px 0;
    border-bottom: 1px solid #ddd;
    font-size: 12px;
    color: #333;
}

.recommendation-item:last-child {
    border-bottom: none;
}

.error-message {
    background: #fff0f0;
    border: 1px solid #cc0000;
    color: #cc0000;
    padding: 15px;
    text-align: center;
}
</style>

<div class="container">
    <div class="logo">
        <a href="/"><img src="{{ url_for('static', path='/logo-title.png') }}" alt="NothingHide" class="logo-img"></a>
    </div>
    
    <p class="tagline">Password Check - Secure k-anonymity intelligence scan</p>
    
    <div class="privacy-notice">
        <strong>Security Protocol Active</strong><br>
        Your password is NEVER transmitted. Only the first 5 characters of its SHA-1 hash are sent to the API. Full comparison happens locally.
    </div>
    
    <form id="password-form">
        <div class="search-box">
            <input type="password" name="password" id="password-input" placeholder="Enter password to check..." required>
        </div>
        <div class="buttons">
            <button type="submit" class="btn" id="submit-btn">Check Password</button>
        </div>
    </form>
    
    <div id="loading-section" class="loading-section">
        <img src="{{ url_for('static', path='/loading.gif') }}" alt="Scanning..." style="width: 80px; height: 80px; margin-bottom: 15px;">
        <div class="loading-text" id="loading-text">Hashing password locally...</div>
    </div>
    
    <div id="results-section" class="results-section"></div>
    
    <a href="/" class="back-link">&laquo; Back to Home</a>
</div>

<script>
const loadingMessages = [
    "Hashing password locally...",
    "Querying breach database...",
    "Analyzing password strength...",
    "Compiling results..."
];

document.getElementById('password-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const password = document.getElementById('password-input').value;
    if (!password) return;
    
    const loadingSection = document.getElementById('loading-section');
    const resultsSection = document.getElementById('results-section');
    const submitBtn = document.getElementById('submit-btn');
    
    loadingSection.style.display = 'block';
    resultsSection.style.display = 'none';
    submitBtn.disabled = true;
    
    let msgIndex = 0;
    const msgInterval = setInterval(() => {
        msgIndex = (msgIndex + 1) % loadingMessages.length;
        document.getElementById('loading-text').textContent = loadingMessages[msgIndex];
    }, 1500);
    
    try {
        const response = await fetch('/password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
            },
            body: `password=${encodeURIComponent(password)}`
        });
        
        clearInterval(msgInterval);
        loadingSection.style.display = 'none';
        submitBtn.disabled = false;
        
        const data = await response.json();
        
        if (data.error) {
            resultsSection.innerHTML = `<div class="error-message">${data.error}</div>`;
            resultsSection.style.display = 'block';
            return;
        }
        
        renderResults(data);
        resultsSection.style.display = 'block';
        
    } catch (error) {
        clearInterval(msgInterval);
        loadingSection.style.display = 'none';
        submitBtn.disabled = false;
        resultsSection.innerHTML = `<div class="error-message">Connection failed. Please try again.</div>`;
        resultsSection.style.display = 'block';
    }
});

function renderResults(data) {
    const resultsSection = document.getElementById('results-section');
    const isCompromised = data.compromised || data.pwned || (data.count && data.count > 0);
    const count = data.count || data.times_exposed || 0;
    
    let html = '';
    
    if (isCompromised) {
        html += `
            <div class="result-card result-compromised">
                <div class="result-icon">⚠️</div>
                <div class="result-title">Password Compromised!</div>
                <div class="result-count">Found ${count.toLocaleString()} times in data breaches</div>
            </div>
        `;
    } else {
        html += `
            <div class="result-card result-safe">
                <div class="result-icon">✓</div>
                <div class="result-title">Password Not Found in Breaches</div>
                <div class="result-count">This password was not found in known data breaches</div>
            </div>
        `;
    }
    
    const strength = data.strength || analyzeStrength(data);
    if (strength) {
        const strengthPercent = strength.score !== undefined ? (strength.score / 4 * 100) : 50;
        let strengthClass = 'strength-weak';
        let strengthLabel = 'Weak';
        if (strengthPercent >= 75) { strengthClass = 'strength-strong'; strengthLabel = 'Strong'; }
        else if (strengthPercent >= 50) { strengthClass = 'strength-good'; strengthLabel = 'Good'; }
        else if (strengthPercent >= 25) { strengthClass = 'strength-fair'; strengthLabel = 'Fair'; }
        
        html += `
            <div class="strength-section">
                <h3>Password Strength Analysis</h3>
                <div class="strength-bar-container">
                    <div class="strength-bar ${strengthClass}" style="width: ${strengthPercent}%"></div>
                </div>
                <div class="strength-label">${strengthLabel}</div>
                <div class="strength-details">
                    <div class="strength-item">
                        <span>Length (8+ chars)</span>
                        <span class="${strength.length >= 8 ? 'check-pass' : 'check-fail'}">${strength.length >= 8 ? '✓' : '✗'}</span>
                    </div>
                    <div class="strength-item">
                        <span>Uppercase letters</span>
                        <span class="${strength.has_upper ? 'check-pass' : 'check-fail'}">${strength.has_upper ? '✓' : '✗'}</span>
                    </div>
                    <div class="strength-item">
                        <span>Lowercase letters</span>
                        <span class="${strength.has_lower ? 'check-pass' : 'check-fail'}">${strength.has_lower ? '✓' : '✗'}</span>
                    </div>
                    <div class="strength-item">
                        <span>Numbers</span>
                        <span class="${strength.has_digit ? 'check-pass' : 'check-fail'}">${strength.has_digit ? '✓' : '✗'}</span>
                    </div>
                    <div class="strength-item">
                        <span>Special characters</span>
                        <span class="${strength.has_special ? 'check-pass' : 'check-fail'}">${strength.has_special ? '✓' : '✗'}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (isCompromised || (strength && strength.score < 3)) {
        html += `
            <div class="recommendations-section">
                <h3>Security Recommendations</h3>
                ${isCompromised ? '<div class="recommendation-item">Change this password immediately on all services where you use it</div>' : ''}
                <div class="recommendation-item">Use a password with at least 12 characters</div>
                <div class="recommendation-item">Include uppercase, lowercase, numbers, and special characters</div>
                <div class="recommendation-item">Avoid common words, phrases, or personal information</div>
                <div class="recommendation-item">Use a unique password for each service</div>
                <div class="recommendation-item">Consider using a password manager</div>
            </div>
        `;
    }
    
    resultsSection.innerHTML = html;
}

function analyzeStrength(data) {
    return {
        score: data.strength_score || 2,
        length: data.length || 8,
        has_upper: data.has_uppercase !== false,
        has_lower: data.has_lowercase !== false,
        has_digit: data.has_numbers !== false,
        has_special: data.has_special !== false
    };
}
</script>
{% endblock %}
