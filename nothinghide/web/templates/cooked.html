{% extends "base.html" %}

{% block title %}Cookie Cooked - Active Session Intelligence{% endblock %}

{% block content %}
<div class="container">
    <div class="logo">
        <a href="/"><img src="{{ url_for('static', path='/logo-title.png') }}" alt="NothingHide" class="logo-img"></a>
    </div>
    <h1>Cookie Cooked Intelligence</h1>
    <p class="tagline">Risk-based session anomaly detection and zero-trust protection.</p>

    <div style="margin: 20px 0; text-align: center;">
        <button id="check-btn" class="btn" style="padding: 15px 30px; font-size: 1.2em;">Check Session Security</button>
    </div>

    <div id="results-area" style="display: none; margin-top: 30px;">
        <div class="result-card">
            <h3>Active Sessions</h3>
            <div id="sessions-list"></div>
        </div>

        <div class="result-card" style="margin-top: 20px;">
            <h3>Cross-Website Cookie Tracking</h3>
            <p style="font-size: 0.8em; color: #888;">Websites currently storing or using your session cookies:</p>
            <div id="tracked-sites-list" style="margin-top: 10px;"></div>
        </div>
        
        <div class="result-card" style="margin-top: 20px;">
            <h3>Security Recommendations</h3>
            <ul id="recommendations-list" style="text-align: left; display: inline-block;"></ul>
        </div>
    </div>
</div>

<script>
document.getElementById('check-btn').addEventListener('click', async () => {
    const btn = document.getElementById('check-btn');
    const resultsArea = document.getElementById('results-area');
    const sessionsList = document.getElementById('sessions-list');
    const trackedList = document.getElementById('tracked-sites-list');
    const recsList = document.getElementById('recommendations-list');

    btn.innerText = 'Scanning...';
    btn.disabled = true;

    try {
        const res = await fetch('/api/cooked/dashboard');
        const data = await res.json();
        
        // ... (existing session logic) ...
        sessionsList.innerHTML = '';
        data.sessions.forEach(s => {
            const div = document.createElement('div');
            div.style.padding = '15px';
            div.style.border = '1px solid #444';
            div.style.margin = '10px 0';
            div.style.borderRadius = '8px';
            div.style.backgroundColor = s.is_current ? '#1a2634' : '#111';
            div.innerHTML = `<strong>${s.device}</strong> <span style="float:right">Risk: ${s.risk_score}</span><br><small>${s.region}</small>`;
            sessionsList.appendChild(div);
        });

        // Tracked Sites Logic
        trackedList.innerHTML = '';
        if (data.tracked_websites.length === 0) {
            trackedList.innerHTML = '<p style="color: #666;">No external cookie usage detected yet. Install extension to begin tracking.</p>';
        } else {
            data.tracked_websites.forEach(site => {
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.borderBottom = '1px solid #333';
                div.style.textAlign = 'left';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span>üåê <strong>${site.url}</strong></span>
                        <span style="color: ${site.risk === 'High' ? 'red' : 'green'}">${site.risk} Risk</span>
                    </div>
                    <small style="color: #666">Detected: ${site.detected_at}</small>
                `;
                trackedList.appendChild(div);
            });
        }

        recsList.innerHTML = '';
        data.recommendations.forEach(r => {
            const li = document.createElement('li');
            li.innerText = r;
            recsList.appendChild(li);
        });

        resultsArea.style.display = 'block';
    } finally {
        btn.innerText = 'Check Session Security';
        btn.disabled = false;
    }
});
</script>
{% endblock %}
